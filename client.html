<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="images/original-app-hd.png" type="image/x-icon">
    <link rel="icon" href="images/original-app-hd.png" type="image/x-icon">
    <title>Prenota Interrogazioni</title>
    <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
    <div class="mainDiv hided" id="welcome">
        <h1>Benvenuto, crea il primo account admin per continuare!</h1>
        <p>Inserisci il tuo nome per iniziare!</p>
        <input type="text" name="name" id="name" placeholder="Nome Utente">
        <p>Il tuo UserID / Chiave di accesso (clicca per copiare):</p>
        <input type="text" name="uid" id="uid" style="cursor: pointer;" readonly onclick="navigator.clipboard.writeText(this.value);alert('UserID Copiato!');">
        <button onclick="window.actions.welcomeCreate(this);">Accedi</button>
    </div>
    <div class="mainDiv hided" id="login">
        <h1>Ciao! Accedi per continuare.</h1>
        <p>Inserisci un ID oppure usa un link diretto se ne hai uno a disposizione.</p>
        <input type="text" name="UID" id="UID">
        <button onclick="window.actions.login(this);">Accedi</button>
    </div>
    <div class="mainDiv hided" id="login-account-not-found">
        <h1>Il tuo account non esiste!</h1>
        <p>Inserisci un nuovo ID oppure usa un link diretto se ne hai uno a disposizione.</p>
        <input type="text" name="UID" id="UID">
        <button onclick="window.actions.login(this);">Accedi</button>
    </div>
    <div class="mainDiv hided" id="changeprofile">
        <h1>Scegli un profilo!</h1>
        <p>Scegli un profilo in cui sei registrato per continuare!</p>
        <select name="profile" id="profile" class="id-select-profilelist" required>
            <option value="default" selected>Scegli un profilo (Profilo Default)</option>
        </select>
        <div class="inline">
            <button type="button" onclick="window.actions.changeUser(this);">Cambia Utente</button>
            <button type="submit" onclick="window.actions.changeProfile(document.getElementById('profile').value);">Accedi</button>
        </div>
    </div>
    <div class="mainDiv hided" id="schedule-subject">
        <h1>Ciao, <span class="dummy" id="javascript-change-user-name">$USERNAME</span>!</h1>
        <p>Per quale materia vuoi prenotarti?</p>
        <select name="subject" id="subject" class="id-select-subjectlist" required>
            <option selected disabled>Scegli una materia</option>
        </select>
        <div class="inline">
            <button type="button" id="changeProfileButton" onclick="CHANGESEC('changeprofile');">Cambia Profilo</button>
            <button type="submit" onclick="window.actions.changeSubject(document.getElementById('subject').value);">Conferma</button>
        </div>
    </div>
    <div class="mainDiv hided" id="dayunavailable">
        <h1>Non puoi prenotarti per questo giorno!</h1>
        <button onclick="window.actions.changeDay();">Cambia giorno</button>
    </div>
    <div class="mainDiv hided" id="alreadyscheduled">
        <h1>Ti sei già prenotato! Non puoi cambiare la tua scelta.</h1>
        <p>Sarai interrogato in data: <span class="dummy" id="javascript-change-schedule-data-day">$SUBJECTDATE</span></p>
        <button id="changeSubjectButton" class="notInlineBtn" onclick="window.actions.changeSubject('');">Cambia Materia</button>
    </div>
    <div class="mainDiv hided" id="scheduleconfirmed">
        <h1>Ti sei prenotato!</h1>
        <p>Ti sei prenotato a <span class="dummy" id="javascript-change-schedule-data">$SUBJECTNAME</span> per il <span class="dummy" id="javascript-change-schedule-data-day">$SUBJECTDATE</span>!</p>
        <button id="changeSubjectButton" class="notInlineBtn" onclick="window.actions.changeSubject('');">Cambia Materia</button>
    </div>
    <div class="mainDiv hided" id="schedulefailed">
        <h1>Whoops! :( </h1>
        <p>C'è stato un problema mentre provavi a prenotarti, per favore riprova o cambia giorno.</p>
        <button onclick="window.actions.changeDay();">Cambia giorno</button>
    </div>
    <div class="mainDiv hided" id="nodays">
        <h1>Questa materia è bloccata o non ha interrogazioni!</h1>
        <button id="changeSubjectButton" class="notInlineBtn" onclick="window.actions.changeSubject('');">Cambia Materia</button>
    </div>
    <div class="mainDiv hided" id="schedule-day">
        <h1>Che giorno vuoi farti interrogare?</h1>
        <p>Non potrai cambiare la tua scelta.</p>
        <select name="day" id="day" class="id-select-daylist">
            <option value="" selected disabled>Scegli un giorno</option>
        </select>
        <div class="inline">
            <button id="changeSubjectButton" onclick="window.actions.changeSubject('');">Cambia Materia</button>
            <button onclick="window.actions.scheduleDay(document.getElementById('day').value)">Conferma</button>
        </div>
    </div>
    <script>
        (()=>{var script = document.createElement('script');script.src="//cdn.jsdelivr.net/npm/eruda";document.body.appendChild(script);script.onload = ()=>{
            eruda.init();
            document.querySelector('#eruda').style.display = "none";
            var toggleBtn = document.createElement('button');
            toggleBtn.style.position = "fixed";
            toggleBtn.style.left = "8px";
            toggleBtn.style.top = "8px";
            toggleBtn.style.width = "30px";
            toggleBtn.style.height = "30px";
            toggleBtn.style.padding = "0";
            toggleBtn.style.border = "0";
            toggleBtn.style.opacity = "0";
            toggleBtn.style.cursor = "default";
            toggleBtn.style.margin = "0";
            toggleBtn.style.zIndex = "2147483647";
            toggleBtn.innerHTML = "";
            toggleBtn.onclick = ()=>document.querySelector('#eruda').style.display = document.querySelector('#eruda').style.display === "none" ? "block" : "none";
            document.body.appendChild(toggleBtn);
        }})();
    </script>
    <script src="/assets/dash.js"></script>
    <script>
        const uid = ('xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        }));
        document.querySelector('input[name=\'uid\']').value = uid;
    </script>
    <script>
        const PWA = window.matchMedia('(display-mode: standalone)').matches;
        window.UID = new URLSearchParams(location.search).get('UID') ?? localStorage["cachedUID"];
        window.SUBJECT = new URLSearchParams(location.search).get('subject');
        window.PROFILE = new URLSearchParams(location.search).get('profile') ?? false;

        var link = document.createElement('link');
        link.rel = 'manifest';
        link.href = `/assets/manifest.php?UID=${window.UID}`;
        document.head.appendChild(link);

        function CHANGESEC(section) {
            if (!document.querySelector('.mainDiv#'+section)) return false;
            document.querySelectorAll('.mainDiv').forEach(e=>e.classList.add('hided'));
            document.querySelector('.mainDiv#'+section).classList.remove('hided');
        }

        window.renderPage = (async (UID = window.UID, subject = window.SUBJECT, profile = window.PROFILE)=>{
            window.UID = UID;
            window.SUBJECT = subject;
            window.PROFILE = profile;
            window.isAdmin = false;
            localStorage["cachedUID"] = window.UID;

            window.pageData = {section: "login"};
            if (window.UID) {
                window.pageData = await fetch(`manager.php?UID=${window.UID}&subject=${window.SUBJECT ?? ""}&scope=loadPageData${(!!window.PROFILE && window.PROFILE != false) ? `&profile=${window.PROFILE}` : ``}`, {
                    method: 'POST',
                    body: JSON.stringify({})
                }).then(r=>r.json());
                if (window.pageData.status === false && window.pageData.message === "This profile does not exist!") {
                    await fetch(`manager.php?profile=default`);
                    location.reload();
                    //! Critical page error, return to default profile!
                }
                /*
                {
                    section: "sectionName",
                    user: {...userData, subjectData: {day: "whenAreTheyScheduled"}};
                    users: [userList] (IF ADMIN),

                    profiled: boolean (is custom profile),
                    profiles: [profileData],
                    profileList: [{name: profileName, admin: isUserAdmin}],

                    subject: {name, days, lock}
                    subjectList: [subjects]
                }
                */
                window.userData = window.pageData.user;
                window.isAdmin = window.userData.admin;
                window.users = window.pageData.users;
                window.profiles = window.pageData.profiles;
                window.isCustomProfile = window.pageData.profiled;
                window.PROFILE = window.isCustomProfile;
                window.notifications = new PushNotifications(window.UID, "manager.php");
                if (!!window.UID && window.UID.length > 0) localStorage["lastUID"] = window.UID;
                localStorage["lastPathName"] = location.pathname;

                document.querySelector('#changeProfileButton').classList.add("hided");
                document.querySelector('#changeProfileButton').parentNode.classList.remove("inline");
                document.querySelectorAll('#changeSubjectButton').forEach(e=>e.classList.add("hided"));
                document.querySelectorAll('#changeSubjectButton:not(.notInlineBtn)').forEach(e=>e.parentNode.classList.remove("inline"));
                document.querySelector('select.id-select-profilelist').querySelectorAll('option:not(option[selected])').forEach(e=>e.remove());
                document.querySelector('select.id-select-subjectlist').querySelectorAll('option:not(option[selected])').forEach(e=>e.remove());
                document.querySelector('select.id-select-daylist').querySelectorAll('option:not(option[selected])').forEach(e=>e.remove());
                for (var profile in window.pageData.profileList) {
                    document.querySelector('#changeProfileButton').classList.remove("hided");
                    document.querySelector('#changeProfileButton').parentNode.classList.add("inline");
                    document.querySelector('select.id-select-profilelist').innerHTML += `<option value="${window.pageData.profileList[profile].name}">${profile.admin ? `<b>Admin</b> ` : ``}${window.pageData.profileList[profile].name}</option>`;
                }
                var subjcount = 0;
                for (var subject of window.pageData.subjectList) {
                    subjcount++;
                    if (subjcount > 1) {
                        document.querySelectorAll('#changeSubjectButton').forEach(e=>e.classList.remove("hided"));
                        document.querySelectorAll('#changeSubjectButton:not(.notInlineBtn)').forEach(e=>e.parentNode.classList.add("inline"));
                    }
                    document.querySelector('select.id-select-subjectlist').innerHTML += `<option value="${subject}">${subject}</option>`;
                }
                for (var day in window.pageData.subject.days) {
                    document.querySelector('select.id-select-daylist').innerHTML += `<option value="${day}" ${window.pageData.subject.days[day].availability.split('/')[0] === "0" ? "disabled" : ""}>(${window.pageData.subject.days[day].availability} Liberi) ${window.pageData.subject.days[day].dayName} ${day}</option>`;
                }

                document.querySelectorAll('#javascript-change-user-name').forEach(e=>e.innerHTML = window.userData.name);
                document.querySelectorAll('#javascript-change-schedule-data').forEach(e=>e.innerHTML = window.SUBJECT);
                document.querySelectorAll('#javascript-change-schedule-data-day').forEach(e=>e.innerHTML = window.userData.subjectData.day);
            
                await window.notifications.status().then(async r=>{
                    if (r != true) return;
                    const sw = await navigator.serviceWorker.getRegistration();
                    if (!window.userData.pushSubscriptions || !sw) return window.notifications.unsubscribe();
                    const sub = await sw.pushManager.getSubscription();
                    const userSubscriptions = new Set();
                    for (var rsub of window.userData.pushSubscriptions) userSubscriptions.add(JSON.stringify(rsub));
                    if (!userSubscriptions.has(JSON.stringify(sub))) return window.notifications.unsubscribe(false);
                    window.notifications.update();
                    navigator.serviceWorker.addEventListener("message", (e)=>console.log(JSON.parse(e.data)));
                })

                function analizzaDati(options = {}) {
                    const defaultOptions = {
                        clipboard: false,
                        copy: "json",
                        log: true,
                        data: undefined,
                        subject: undefined,
                        users: undefined,
                        minimal: false,
                    };
                    options = {...defaultOptions, ...options};
                    const copyToClipboard = options.clipboard ?? false;
                    const valueToCopy = options.copy ?? "json";
                    const logger = options.log ? console : {group: ()=>{}, groupEnd: ()=>{}, error: ()=>{}, log: ()=>{}};

                    const utenti = options.users ?? window.users;
                    const datiMateria = options.data ?? window.pageData.currentSubject;
                    if (!datiMateria) return false;
                    const materia = options.subject ?? window.SUBJECT;
                    const messageArr = [];
                    var listaPrenotazioni = {};

                    for (var data in datiMateria.days ?? []) {
                        listaPrenotazioni[data] ??= {
                            header: options.minimal 
                                ? `${datiMateria.days[data].dayName} ${data}`
                                : `[${datiMateria.days[data].availability}] ${datiMateria.days[data].dayName} ${data}`,
                            answers: []
                        }
                    }

                    for (var utente in datiMateria.answers) {
                        let date = datiMateria.answers[utente].date;
                        listaPrenotazioni[datiMateria.answers[utente].date] ??= {
                            header: options.minimal 
                                ? `${new Date(`${date.split("-")[1]}-${date.split("-")[0]}-${date.split("-")[2]}`).toLocaleString("it-IT", {weekday: "long"})} ${datiMateria.answers[utente].date}`
                                : `[??] ${new Date(`${date.split("-")[1]}-${date.split("-")[0]}-${date.split("-")[2]}`).toLocaleString("it-IT", {weekday: "long"})} ${datiMateria.answers[utente].date}`,
                            answers: []
                        };
                        listaPrenotazioni[datiMateria.answers[utente].date].answers.push(
                            options.minimal
                                ? `${utenti[utente].name}`
                                : `[${datiMateria.answers[utente].answerNumber}] ${utenti[utente].name}`
                        );
                    }

                    var listaPrenotazioniText = options.minimal ? `${materia}: ---\n` : `[${materia}] Prenotati (Numero Risposta, Nome): ---\n`;
                    for (var data in listaPrenotazioni) {
                        listaPrenotazioniText+="\n"+data+"\n"+listaPrenotazioni[data].answers.join("\n")+"\n";
                    }
                    
                    logger.group("Lista Prenotazioni per "+materia);
                    listaPrenotazioniText.length > 0 && logger.log(listaPrenotazioniText);
                    logger.groupEnd();

                    const returnOBJ = {
                        prenotazioni: listaPrenotazioniText,
                        linkUtente: messageArr
                    };

                    if (copyToClipboard) {
                        var toCopy = "";
                        if (!valueToCopy) valueToCopy = "json";
                        if (valueToCopy != "json" && returnOBJ[valueToCopy]) toCopy = returnOBJ[valueToCopy];
                        else toCopy = JSON.stringify(returnOBJ);
                        navigator.clipboard.writeText(toCopy);
                    }

                    return returnOBJ;
                }

                window.btnDiv = window.btnDiv ?? document.createElement("div");
                    btnDiv.style.display = "flex";
                    btnDiv.style.position = "fixed";
                    btnDiv.style.bottom = "10px";
                    btnDiv.style.right = "10px";
                    btnDiv.style.gap = "2.5px";
                    btnDiv.innerHTML = "";

                if (isAdmin) {
                    if (analizzaDati() != false) {
                        let btn = document.createElement("button");
                            btn.innerHTML = "Copia le prenotazioni";
                            btn.onclick = ()=>{
                                btn.innerHTML = "Prenotazioni copiate!";
                                setTimeout(()=>btn.innerHTML = "Copia le prenotazioni", 3000);
                                analizzaDati({
                                    clipboard: true, 
                                    copy: "prenotazioni", 
                                    log: false
                                });
                            };
                        btnDiv.appendChild(btn);
                    }
                }
                
                let btn = document.createElement("button");
                    btn.innerHTML = "Dati utente";
                    btn.onclick = ()=>{
                        window.dash = (!!(window.dash ?? {closed: true}).closed) ? new UserDashboard(null, {admin: isAdmin, onOpenAdminDash: ()=>{
                            fetch(`manager.php?UID=${window.UID}&scope=getAllData`).then(r=>r.json()).then(r=>{
                                window.adminDash = new AdminDashboard(null, {
                                    fetchPrefix: "manager.php",
                                    subjects: r,
                                    updateCallback: (type, fullData, fileData, forceBlockRefresh = false)=>{
                                        console.log(fullData, fileData);
                                        fetch(`manager.php?UID=${window.UID}&scope=updateSettings&type=${type}`, {
                                            method: "POST",
                                            body: JSON.stringify([fileData])
                                        }).then(r=>r.json()).then(r=>{
                                            console.log(r);
                                            if (r.status != true) alert("Impossibile completare l'azione!");
                                            else {
                                                // alert("Dati aggiornati con successo!");
                                                !forceBlockRefresh && window.adminDash && window.adminDash.update({
                                                    subjects: r.newData.subjects,
                                                    users: r.newData.users,
                                                    profiles: !!r.newData.profiles ? r.newData.profiles : undefined
                                                });
                                            }
                                        });
                                    },
                                    users: window.users,
                                    profiles: window.profiles,
                                    analysisFunction: analizzaDati,
                                    notificationClass: window.notifications,
                                    refreshUsers: async ()=>{
                                        const res = await fetch(`manager.php?UID=${window.UID}&scope=getAllUsers`).then(r=>r.json());
                                        return (res.status === false) ? {} : res;
                                    },
                                    refreshProfiles: async()=>{
                                        const res = await fetch(`manager.php?UID=${window.UID}&scope=profileMGMT`, {
                                            method: "POST",
                                            body: JSON.stringify({action: "listprofiles"})
                                        }).then(r=>r.json());
                                        return (res.status === false || !res.profiles) ? [] : res.profiles;
                                    },
                                    isCustomProfile: window.isCustomProfile
                                });
                            });
                        }, ...window.userData}, window.notifications) : window.dash;
                    }
                    if (JSON.stringify(userData) != "{}") btnDiv.appendChild(btn);
                document.documentElement.appendChild(btnDiv);
            }

            
            window.actionManager = [[], async (promise = false)=>{
                if (!window.navigator.onLine) return window.actionManager[0].push(promise);
                // Logic to execute all promises
            }];
            window.addEventListener('online', ()=>window.actionManager[1]());
            

            window.actions = {
                welcomeCreate: function(elThis) {
                    const promise = new Promise(async (re)=>{
                        const body = {};
                        body[elThis.parentNode.querySelector('input[name=\'uid\']').value] = {
                            name: elThis.parentNode.querySelector('input[name=\'name\']').value,
                            admin: true,
                            answers: {}
                        };
                        const r = await fetch(`manager.php?scope=updateSettings&type=users`, {method: 'POST', body: JSON.stringify([body])}).then(r=>r.json());
                        if (!r.status) return r(alert('Impossibile completare l\'azione!'));
                        re(await window.renderPage(elThis.parentNode.querySelector('input[name=\'uid\']').value));
                    });
                    window.actionManager[1](promise);
                    return promise;
                },
                login: function(elThis) {
                    const promise = new Promise(async (r)=>{
                        document.getElementById('UID').value =
                            document.getElementById('UID').value.indexOf('UID=') != -1
                                ? (new URLSearchParams(`?${document.getElementById('UID').value.split('?', 2)[1]}`)).get('UID')
                                : document.getElementById('UID').value;
                        r(await window.renderPage(document.getElementById('UID').value));
                    });
                    window.actionManager[1](promise);
                    return promise;
                },
                changeUser: function(elThis) {
                    const promise = new Promise(async (r)=>{
                        r(await window.renderPage(''));
                    });
                    window.actionManager[1](promise);
                    return promise;
                },
                changeProfile: function(profile = window.PROFILE) {
                    const promise = new Promise(async (r)=>{
                        r(await window.renderPage(undefined, undefined, profile));
                    });
                    window.actionManager[1](promise);
                    return promise;
                },
                changeSubject: function(subject = window.SUBJECT) {
                    const promise = new Promise(async (r)=>{
                        r(await window.renderPage(undefined, subject));
                    });
                    window.actionManager[1](promise);
                    return promise;
                },
                changeDay: function() {
                    const promise = new Promise(async (r)=>{
                        r(await window.renderPage());
                    });
                    window.actionManager[1](promise);
                    return promise;
                },
                scheduleDay: function(day) {
                    const promise = new Promise(async (r)=>{
                        const res = await fetch(`manager.php?UID=${window.UID}&scope=schedule&subject=${window.SUBJECT}&day=${day}`).then(r=>r.json());
                        if (res.status === true) {
                            document.querySelectorAll('#javascript-change-schedule-data').forEach(e=>e.innerHTML = window.SUBJECT);
                            document.querySelectorAll('#javascript-change-schedule-data-day').forEach(e=>e.innerHTML = day);
                            return r(CHANGESEC("scheduleconfirmed"));
                        }
                        if (res.message === "Invalid Day!") r(CHANGESEC("dayunavailable"));
                        return r(CHANGESEC("schedulefailed"));
                    });
                    window.actionManager[1](promise);
                    return promise;
                }
            };

            CHANGESEC(window.pageData.section);
        });
        window.renderPage();

        window.addEventListener("beforeinstallprompt", (e)=>{
            e.preventDefault();
            window.installEvent = e;
            window.btn2 = window.btn2 ?? document.createElement("button");
            btn2.innerHTML = "Installa App";
            btn2.onclick = ()=>{
                window.installEvent && window.installEvent.prompt();
            }
            btnDiv.appendChild(btn2);
        });
    </script>
</body>
</html>